name: Job Finder CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # -------------------------------------------------------------------------
  # JOB 1: CI - Build and Test Python Worker
  # -------------------------------------------------------------------------
  ci_test_and_build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Install Python dependencies (for testing on the runner)
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          # Assuming you use a requirements.txt with 'requests' or 'httpx' for local running
          pip install -r backend/requirements.txt

      - name: Run Unit Tests
        # Placeholder for actual tests (e.g., testing the prompt generation logic)
        run: echo "Running placeholder tests..." # Replace with 'pytest' or similar

      - name: Build Docker Image
        uses: docker/build-push-action@v5
        with:
          # Set the context to the backend directory. This ensures the Docker daemon only
          # sees the necessary files (Python code, requirements.txt) for the build.
          context: ./backend
          # CRITICAL FIX: Explicitly point to the Dockerfile using its full path
          # relative to the repository root. This resolves runner ambiguities.
          file: ./backend/Dockerfile
          push: false
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/ai-job-search-worker:latest

      - name: Archive Built Artifacts (Optional)
        # Saves the successfully built image for potential reuse in later stages
        uses: actions/upload-artifact@v4
        with:
          name: ai-job-search-worker-image
          path: /tmp/ai-job-search-worker.tar # Docker save path (requires intermediate step)

      # -------------------------------------------------------------------------
      # React Front-end Build (Simulating the Single-File React App from earlier)
      # -------------------------------------------------------------------------
      - name: Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build React Static Assets
        # In a real environment, this would install npm dependencies and run 'npm run build'
        run: |
          mkdir build
          echo "<html><body><h1>Job Finder UI Placeholder</h1></body></html>" > build/index.html
          echo "Front-end build completed."

      - name: Archive Front-end Build
        uses: actions/upload-artifact@v4
        with:
          name: ai-job-search-ui-build
          path: build

  # -------------------------------------------------------------------------
  # JOB 2: CD - Publish Docker Container (Requires CI success)
  # -------------------------------------------------------------------------
  cd_publish_worker:
    needs: [ci_test_and_build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/ai-job-search-worker:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/ai-job-search-worker:${{ github.sha }}

  # -------------------------------------------------------------------------
  # JOB 3: CD - Deploy Static Front-end (React UI)
  # -------------------------------------------------------------------------
  cd_deploy_frontend:
    needs: [ci_test_and_build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Download Front-end Artifact
        uses: actions/download-artifact@v4
        with:
          name: ai-job-search-ui-build
          path: build

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build
          cname: your-ai-job-search.com # Optional: if you map a custom domain
